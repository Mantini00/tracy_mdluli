<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>For You, My Valentine ‚ù§Ô∏è</title>
  <meta name="description" content="A little website I made for you. Will you be my Valentine?" />
  <!-- Leaflet Map (for the distance map) -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#7b0f1c;
      --bg2:#d56a78;
      --txt:#2a2a2a;
      --white:#ffffff;
      --primary:#9b1c2c;
      --accent:#e8a0a8;
      --soft:#fff5f7;
      --btn:#ffffff;
    }

    html,body{margin:0;padding:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji";
      color:var(--txt);
      background: linear-gradient(135deg,var(--bg1),var(--bg2));
      min-height:100dvh; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
      display:flex; flex-direction:column;
    }
    .wrap {
    max-width: 920px;
    margin: 0 auto;
    /* Initial padding as fallback for browsers that don't support env() */
    padding: 18px 16px 64px;
    /* Then override each side with env() support */
    padding-left: max(16px, env(safe-area-inset-left));
    padding-right: max(16px, env(safe-area-inset-right));
    padding-bottom: calc(64px + env(safe-area-inset-bottom));
    padding-top: max(18px, env(safe-area-inset-top));
    }

    header{text-align:center;color:#111;padding:24px 12px 8px;}
    .heart-emoji{font-size:42px; animation: beat 1.2s infinite ease-in-out}
    @keyframes beat{0%,100%{transform:scale(1)}50%{transform:scale(1.25)}}
    h1{font-size: clamp(28px, 6vw, 44px); margin: 10px auto 4px; line-height:1.2; color:#1a1a1a;
    font-family: "Playfair Display", ui-serif, Georgia,"Times New Roman"; font-weight:700;
    letter-spacing: 0.2px;
    background: linear-gradient(135deg, var(--bg1), var(--bg2));
    position: relative;
    overflow: hidden;
    }

    header::before {
    content: '';
    position: absolute;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23ff5e7820' fill-opacity='0.15' fill-rule='evenodd'/%3E%3C/svg%3E");
    opacity: 0.4;
    }
    
    h2,{
    font-family: "Playfair Display", ui-serif, Georgia, "Times New Roman", serif;
    letter-spacing: 0.2px; font-weight: 600;
    }

    .sub{margin:6px auto 14px; color:#333; opacity:.9;}

    .card{
      background: var(--white); border-radius:20px; box-shadow: 0 12px 30px rgba(0,0,0,.12);
      padding:18px; margin:14px 0;
      border: 1px solid transparent;
    }

    /* CTA */
    .cta{ text-align:center; padding:12px 8px 8px; }
    .big-q{ font-size: clamp(22px, 5.5vw, 32px); margin:12px 0 16px; color:#111; }
    .btns{ display:flex; gap:12px; justify-content:center; align-items:center; flex-wrap:wrap; }
    button,a.btn{
      appearance:none; border:none; cursor:pointer; background:var(--btn); color:var(--primary);
      padding:14px 22px; border-radius:999px; font-weight:700; font-size:18px;
      box-shadow: 0 6px 16px rgba(255,94,120,.35);
      transition: transform .08s ease, box-shadow .2s ease, background .2s ease; text-decoration:none;
    }
    button.primary{ background:var(--primary); color:white }
    button:hover, a.btn:hover{ transform: translateY(-1px) }
    button:active, a.btn:active{ transform: translateY(1px) }
    .no-btn{ background:#fff; color:#ff3b57; position:relative }

    /* Countdown */
    .countdown{ display:grid; grid-template-columns: repeat(4,1fr); gap:10px; text-align:center; }
    .countdown .unit{ background:var(--soft); border-radius:14px; padding:10px 8px; }
    .num{font-size: clamp(20px, 6vw, 32px); font-weight:800; color:#111}
    .lbl{font-size:12px; letter-spacing:.4px; color:#555}

    /* Map */
    #map{ width:100%; height:320px; border-radius:14px; overflow:hidden; }
    .distance-line{ margin-top:10px; font-size:14px; color:#444 }
    .map-note{ font-size:12px; color:#555 }

    /* Gallery - IMPROVED */
    .grid{ 
      display:grid; 
      gap:10px; 
      grid-template-columns: repeat(3, 1fr); 
    }
    .grid-item {
      position: relative;
      overflow: hidden;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(0,0,0,.15);
    }
    .grid img{
      width:100%; 
      height:110px; 
      object-fit:cover;
      transition: transform 0.4s ease;
    }
    .grid-item:hover img {
      transform: scale(1.08);
    }
    .photo-caption {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.7));
      color: white;
      padding: 8px;
      font-size: 11px;
      opacity: 0;
      transition: opacity 0.3s ease;
      transform: translateY(10px);
    }
    .grid-item:hover .photo-caption {
      opacity: 1;
      transform: translateY(0);
    }
    @media (max-width:640px){ 
      .grid{grid-template-columns: repeat(2, 1fr)} 
      .grid img{height:140px} 
    }
    @media (max-width:420px){ 
      .grid{grid-template-columns: 1fr} 
      .grid img{height:220px} 
    }

    /* Our Story Timeline */
    .timeline {
      position: relative;
      padding: 20px 0;
    }
    .timeline::before {
      content: '';
      position: absolute;
      left: 20px;
      top: 0;
      bottom: 0;
      width: 3px;
      background: linear-gradient(to bottom, var(--primary), var(--accent));
      border-radius: 3px;
    }
    .timeline-item {
      position: relative;
      padding-left: 50px;
      margin-bottom: 30px;
    }
    .timeline-item:last-child {
      margin-bottom: 0;
    }
    .timeline-item::before {
      content: '';
      position: absolute;
      left: 16px;
      top: 5px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--primary);
      border: 3px solid white;
      box-shadow: 0 0 0 3px var(--primary);
      z-index: 2;
    }
    .timeline-date {
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 4px;
      font-size: 15px;
    }
    .timeline-title {
      font-weight: 600;
      margin: 0 0 6px 0;
      color: #111;
      font-family: "Playfair Display", ui-serif, Georgia, "Times New Roman", serif;
        letter-spacing: 0.2px;


    }
    .timeline-desc {
      margin: 0;
      color: #555;
      line-height: 1.5;
      font-size: 14px;
    }
    @media (min-width: 640px) {
      .timeline::before {
        left: 50%;
        transform: translateX(-50%);
      }
      .timeline-item {
        width: 50%;
        padding-left: 0;
        padding-right: 50px;
      }
      .timeline-item:nth-child(odd) {
        margin-left: 50%;
        padding-left: 50px;
        padding-right: 0;
      }
      .timeline-item:nth-child(odd)::before {
        left: -6px;
      }
      .timeline-item:nth-child(even)::before {
        right: -6px;
        left: auto;
      }
    }

    /* Lightbox */
    .lightbox{ 
      position:fixed; 
      inset:0; 
      background:rgba(0,0,0,.9); 
      display:none;
      justify-content:center; 
      align-items:center; 
      z-index:60; 
      padding:20px; 
    }
    .lightbox img{ 
      max-width:96vw; 
      max-height:85vh; 
      border-radius:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.5);
    }
    .lightbox.active{ display:flex }
    .close{ 
      position:absolute; 
      top:20px; 
      right:20px; 
      background:rgba(255,255,255,0.9); 
      border-radius:999px;
      padding:10px 15px; 
      font-weight:700;
      border: none;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
    }
    .close:hover {
      background: white;
      transform: scale(1.1);
    }

    /* Letter */
    .letter{ background:#fffafc; border:2px dashed #ffc5d0; border-radius:16px; padding:16px; line-height:1.7; }

    /* Floating hearts */
    .float-hearts{ position:fixed; left:0; right:0; bottom:-20px; pointer-events:none; z-index:1; }
    .heart{ position:absolute; bottom:-20px; font-size:16px; opacity:.7; animation: rise linear forwards; }
    @keyframes rise{ to { transform: translateY(-110vh); opacity:0 } }

    /* Confetti */
    .confetti{ position:fixed; inset:0; pointer-events:none; z-index:80 }

    /* Password Lock Overlay */
    .lock{
      position:fixed; inset:0; background:linear-gradient(135deg, var(--bg1), var(--bg2));
      display:flex; align-items:center; justify-content:center; z-index:100; padding:24px;
    }

    
/* Soft vignette behind the lock box */
.lock::before{
  content:"";
  position: absolute;
  inset: 0;
  background:
    radial-gradient(ellipse at center, rgba(0,0,0,0.28) 0%, rgba(0,0,0,0.5) 100%);
  pointer-events: none;
  z-index: 0; /* sits behind the box */
}

    .lock .box{
      background:#fff; border-radius:20px; box-shadow:0 16px 40px rgba(0,0,0,.2);
      width:100%; max-width:460px; padding:22px;
      text-align:center;
      position: relative;
z-index: 1

    }
    .lock h2{ margin:4px 0 10px; }
    .lock p{ color:#444; margin:0 0 16px }
    .lock input{
      width:100%; padding:14px 16px; border-radius:12px; border:1px solid #ffd1dc;
      font-size:16px; outline:none;
      box-sizing: border-box;
    }
    .lock .action{
      margin-top:14px; display:flex; gap:10px; justify-content:center; flex-wrap:wrap;
    }
    .hint{ font-size:12px; color:#666; margin-top:8px }
    .shake{ animation:shake .36s ease-in-out }
    @keyframes shake{
      0%,100%{ transform: translateX(0) }
      20%{ transform: translateX(-6px) }
      40%{ transform: translateX(6px) }
      60%{ transform: translateX(-4px) }
      80%{ transform: translateX(4px) }
    }

    /* Back to Top Button */
    .back-to-top {
      position: fixed;
      bottom: calc(20px + env(safe-area-inset-bottom));
      right: calc(20px + env(safe-area-inset-right));
      width: 50px;
      height: 50px;
      background: var(--primary);
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      cursor: pointer;
      z-index: 99;
      opacity: 0;
      visibility: hidden;
      transform: translateY(20px);
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(155, 28, 44, 0.3);
      border: none;
    }
    .back-to-top.visible {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    .back-to-top:hover {
      background: #8a1626;
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(155, 28, 44, 0.4);
    }

    /* Accessibility: reduced motion */
    @media (prefers-reduced-motion: reduce){
      .heart-emoji{ animation:none }
      .heart{ animation:none }
      .grid-item:hover img { transform: none; }
      .photo-caption { transition: none; }
    }

    footer{ text-align:center; color:#333; opacity:.9; margin-top:10px; }
    .audio-row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .note{ font-size:12px; color:#555 }
  </style>
</head>
    
<body>
  <!-- Password Lock Overlay -->
  <div class="lock" id="lockOverlay" aria-modal="true" role="dialog" aria-label="Unlock">
    <div class="box" id="lockBox">
      <div class="heart-emoji" aria-hidden="true">üîíüíñ</div>
      <h2>A little secret first</h2>
      <p>Which name do I use when I want to annoy you?</p>
      <input type="password" id="passInput" placeholder="Type the secret‚Ä¶" autocomplete="off" />
      <div class="action">
        <button class="primary" id="unlockBtn">Unlock</button>
      </div>
      <div class="hint">Hint: It's my favourite of your three names :).</div>
    </div>
  </div>

  <!-- Back to Top Button -->
  <button class="back-to-top" id="backToTop" aria-label="Back to top">‚Üë</button>

  <div class="wrap" aria-hidden="true" id="contentWrap">
    <header aria-label="Intro">
      <div class="heart-emoji" aria-hidden="true">‚ù§Ô∏è</div>
      <h1>For <span id="herName">Tracy</span></h1>
      <p class="sub">Bhekiswako. Luvuno.</p>
    </header>

    <!-- Ask -->
    <section class="card cta" aria-label="Question">
      <div class="big-q">Will you be my Valentine?</div>
      <div class="btns">
        <button class="primary" id="yesBtn" aria-label="Yes">Yes! üíó</button>
        <button class="no-btn" id="noBtn" aria-label="No">Umm‚Ä¶ No?</button>
      </div>
      <p class="note" style="margin-top:10px">Tap "Yes" to unlock a little surprise.</p>
    </section>

    <!-- Gallery - IMPROVED -->
    <section class="card" aria-label="Photos">
      <h2 style="margin:6px 0 12px">Our Memories üì∏</h2>
      <div class="grid" id="gallery">
        <!-- Replace these with your actual photos and captions -->
        <div class="grid-item">
          <img src="photos/IMG_4262.jpeg" alt="Our first date" loading="lazy"/>
          <div class="photo-caption">Our first date ‚ù§Ô∏è</div>
        </div>
        <div class="grid-item">
          <img src="photos/IMG_5480.jpeg" alt="My beautiful sunset" loading="lazy"/>
          <div class="photo-caption">My beautiful sunset</div>
        </div>
        <div class="grid-item">
          <img src="photos/IMG_5324.jpeg" alt="My baby" loading="lazy"/>
          <div class="photo-caption">My baby</div>
        </div>
        <div class="grid-item">
          <img src="photos/IMG_5502.jpeg" alt="Black on black" loading="lazy"/>
          <div class="photo-caption">Black on black</div>
        </div>
        <div class="grid-item">
          <img src="photos/IMG_5375.jpeg" alt="Our beach day" loading="lazy"/>
          <div class="photo-caption">Our beach day</div>
        </div>
        <div class="grid-item">
          <img src="photos/IMG_5910.jpg" alt="Celebrating us" loading="lazy"/>
          <div class="photo-caption">Celebrating us</div>
        </div>
      </div>
      <p class="note" style="margin-top:10px">Hover over photos to see captions. Click to enlarge.</p>
    </section>

    <!-- Our Story Timeline - NEW SECTION -->
    <section class="card" aria-label="Our Story Timeline">
      <h2 style="margin:6px 0 12px">Our Story...So Far üìñ</h2>
      <div class="timeline" id="timeline">
        <!-- Timeline items will be generated by JavaScript -->
      </div>
      <p class="note" style="margin-top:10px">More chapters to be written...</p>
    </section>

    <!-- Countdown -->
    <section class="card" aria-label="Countdown">
      <h2 style="margin:6px 0 12px">Countdown until I see you again ‚è≥</h2>
      <div class="countdown" id="countdown">
        <div class="unit"><div class="num" id="days">‚Äî</div><div class="lbl">Days</div></div>
        <div class="unit"><div class="num" id="hours">‚Äî</div><div class="lbl">Hours</div></div>
        <div class="unit"><div class="num" id="mins">‚Äî</div><div class="lbl">Minutes</div></div>
        <div class="unit"><div class="num" id="secs">‚Äî</div><div class="lbl">Seconds</div></div>
      </div>
      <p class="note" style="margin-top:10px">Date: <span id="targetDateLabel"></span></p>
    </section>

    <!-- Map Distance -->
    <section class="card" aria-label="Map Distance">
      <h2 style="margin:6px 0 12px">Me-to-You Map üó∫Ô∏è</h2>
      <div id="map" role="img" aria-label="Map showing our locations"></div>
      <div class="distance-line" id="distanceText">Calculating distance‚Ä¶</div>
      <p class="map-note">Thank God for WhatsApp.</p>
    </section>

    <!-- Love letter -->
    <section class="card" aria-label="Love Letter">
      <h2 style="margin:6px 0 12px">A letter for you üíå</h2>
      <div class="letter" id="letter">
        <p>Hi <strong><span id="herName2">Baby</span></strong>,</p>
        <p>
          Even from distance away, you make ordinary days feel special. Your smile lives in my head,
          sthandwa sam.
        </p>
        <p>
          I look forward to seeing you again. Until then, I'm sending this
          little corner of the internet to remind you how much you mean to me.
        </p>
        <p>
          So here I am, with all my heart (and head which is far bigger than my heart), asking you: will you be my Valentine?
        </p>
        <p style="margin-top:14px">Yours,<br/>Mthokozisi</p>
      </div>
    </section>

    <!-- Music (optional) -->
    <section class="card" aria-label="Music">
      <h2 style="margin:6px 0 12px">Who's Dat Girl  (Cover) - Asha dynasty üé∂</h2>
      <div class="audio-row">
        <button id="playMusic" class="btn">Play / Pause</button>
        <audio id="song" preload="metadata" src="music/who_dat_girl.mp3"></audio>
      </div>
      <p class="note">Tap the button to play.</p>
    </section>

    <footer>
      <p>Made with ‚ù§Ô∏è by Mthokozisi</p>
    </footer>
  </div>

  <!-- Lightbox for images -->
  <div class="lightbox" id="lightbox" role="dialog" aria-modal="true" aria-label="Photo viewer">
    <button class="close" id="closeLb" aria-label="Close">‚úï</button>
    <img id="lbImg" alt="">
  </div>

  <!-- subtle floating hearts -->
  <div class="float-hearts" id="floatHearts" aria-hidden="true"></div>

  <!-- confetti canvas -->
  <canvas class="confetti" id="confetti"></canvas>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>

  <script>
    /********* PERSONALIZE HERE *********/
    const HER_NAME = "Tracy";
    const PASS_PHRASE = "Natalie"; // fun lock (client-side, not real security)

    // Reunion date/time (local time). Format: YYYY-MM-DDTHH:mm:ss¬±TZ
    const MEET_UP_ISO = "2026-03-20T18:00:00+02:00";

    // Map cities (update with your real city names and coordinates)
    const CITY_A = { name: "Cape Town", lat: -33.9249, lng: 18.4241 }; 
    const CITY_B = { name: "Siteki",  lat: -26.4517, lng: 31.9462 };

    // Our Story Timeline Data - CUSTOMIZE THIS WITH YOUR STORY!
    const OUR_STORY = [
      {
        date: "1 January 2026",
        title: "First Meet",
        desc: "That day at paint and sip..."
      },
      {
        date: "7 January 2026",
        title: "Our First Date",
        desc: "YOU WERE LATE!!! But I was too happy to see you to care"
      },
      {
        date: "31 January 2026",
        title: "Our first beach day",
        desc: "The night we admitted our feelings under the stars (virtually!)."
      },
      {
        date: "14 February 2026",
        title: "Today",
        desc: "You are my valentine‚ù§Ô∏è."
      },
      {
        date: "Coming Soon",
        title: "Baby Comes to Cape Town",
        desc: "We have a concert to attend - I can't wait!",
        special: true
      }
    ];
    /************************************/

    /********* INIT CONTENT *********/
    // Lock overlay
    const lockOverlay = document.getElementById("lockOverlay");
    const contentWrap = document.getElementById("contentWrap");
    const passInput = document.getElementById("passInput");
    const unlockBtn = document.getElementById("unlockBtn");
    const lockBox = document.getElementById("lockBox");

    function unlockIfPassOk(){
      const ok = passInput.value.trim() === PASS_PHRASE.trim();
      if(ok){
        lockOverlay.style.display = "none";
        contentWrap.removeAttribute("aria-hidden");
        // Focus first button for accessibility
        setTimeout(()=>document.getElementById("yesBtn")?.focus(), 50);
      }else{
        lockBox.classList.remove("shake");
        void lockBox.offsetWidth; // restart animation
        lockBox.classList.add("shake");
      }
    }
    unlockBtn.addEventListener("click", unlockIfPassOk);
    passInput.addEventListener("keydown",(e)=>{ if(e.key==="Enter") unlockIfPassOk(); });

    // Set names
    document.getElementById("herName").textContent = HER_NAME;
    document.getElementById("herName2").textContent = HER_NAME;

    // Format and set target date label
    const target = new Date(MEET_UP_ISO);
    document.getElementById("targetDateLabel").textContent = target.toLocaleString([], {
      weekday:"short", year:"numeric", month:"short", day:"2-digit", hour:"2-digit", minute:"2-digit"
    });

    // Countdown
    const dEl = document.getElementById("days");
    const hEl = document.getElementById("hours");
    const mEl = document.getElementById("mins");
    const sEl = document.getElementById("secs");
    function tick(){
      const now = new Date();
      let diff = target - now;
      if(diff < 0) diff = 0;
      const s = Math.floor(diff/1000);
      const days = Math.floor(s / 86400);
      const hours = Math.floor((s % 86400) / 3600);
      const mins = Math.floor((s % 3600) / 60);
      const secs = s % 60;
      dEl.textContent = String(days);
      hEl.textContent = String(hours).padStart(2,"0");
      mEl.textContent = String(mins).padStart(2,"0");
      sEl.textContent = String(secs).padStart(2,"0");
    }
    tick(); setInterval(tick, 1000);

    // Lightbox - UPDATED for new gallery structure
    const lb = document.getElementById("lightbox");
    const lbImg = document.getElementById("lbImg");
    const closeLb = document.getElementById("closeLb");
    document.getElementById("gallery").addEventListener("click", e=>{
      const img = e.target.closest(".grid-item")?.querySelector("img");
      if(!img) return;
      lbImg.src = img.src;
      lbImg.alt = img.alt || "";
      lb.classList.add("active");
      document.body.style.overflow = "hidden"; // Prevent scrolling
    });
    closeLb.addEventListener("click", ()=> {
      lb.classList.remove("active");
      document.body.style.overflow = ""; // Restore scrolling
    });
    lb.addEventListener("click", e=>{ 
      if(e.target===lb) {
        lb.classList.remove("active");
        document.body.style.overflow = "";
      }
    });

    // Music
    const song = document.getElementById("song");
    document.getElementById("playMusic").addEventListener("click", async ()=>{
      if(song.paused){ 
        try{ 
          await song.play(); 
          document.getElementById("playMusic").textContent = "Pause ‚è∏Ô∏è";
        }catch(e){
          console.log("Audio play failed:", e);
        } 
      } else { 
        song.pause(); 
        document.getElementById("playMusic").textContent = "Play ‚ñ∂Ô∏è";
      }
    });
    song.addEventListener("ended", () => {
      document.getElementById("playMusic").textContent = "Play ‚ñ∂Ô∏è";
    });

    // Floating hearts
    const heartsWrap = document.getElementById("floatHearts");
    function spawnHeart(){
      const h = document.createElement("div");
      h.className = "heart";
      h.textContent = "üíñ";
      h.style.left = Math.random()*100 + "vw";
      const dur = 6 + Math.random()*6;
      h.style.animationDuration = dur + "s";
      heartsWrap.appendChild(h);
      setTimeout(()=> h.remove(), dur*1000);
    }
    const ambient = setInterval(spawnHeart, 1400);

    // "No" button dodges
    const noBtn = document.getElementById("noBtn");
    noBtn.addEventListener("mouseenter",()=> moveNo());
    noBtn.addEventListener("touchstart",(e)=>{ e.preventDefault(); moveNo(); },{passive:false});
    function moveNo(){
      const rect = noBtn.getBoundingClientRect();
      const x = Math.random() * (window.innerWidth - rect.width - 20);
      const y = Math.random() * (window.innerHeight - rect.height - 20);
      noBtn.style.position="fixed";
      noBtn.style.left = Math.max(10,x) + "px";
      noBtn.style.top  = Math.max(10,y) + "px";
    }

    // Confetti hearts on "Yes"
    const yesBtn = document.getElementById("yesBtn");
    const canvas = document.getElementById("confetti");
    const ctx = canvas.getContext("2d");
    function resize(){ canvas.width = innerWidth; canvas.height = innerHeight }
    addEventListener("resize", resize); resize();

    let confettiParts = [];
    function launchConfetti(){
      confettiParts = [];
      const count = 120;
      for(let i=0;i<count;i++){
        confettiParts.push({
          x: Math.random()*canvas.width,
          y: -10,
          size: 8 + Math.random()*10,
          speed: 2 + Math.random()*3,
          spin: Math.random()*Math.PI*2,
          color: Math.random()>.5 ? "#ff5e78" : "#ffb6c1"
        });
      }
      let t=0;
      function frame(){
        ctx.clearRect(0,0,canvas.width,canvas.height);
        for(const p of confettiParts){
          p.y += p.speed;
          p.spin += 0.08;
          drawHeart(p.x, p.y, p.size, p.color, p.spin);
        }
        t++;
        if(t<220) requestAnimationFrame(frame);
      }
      frame();
    }
    function drawHeart(x,y,s,color,rot){
      ctx.save(); ctx.translate(x,y); ctx.rotate(rot); ctx.fillStyle=color; ctx.beginPath();
      const k = s/16;
      ctx.moveTo(0, 6*k);
      ctx.bezierCurveTo(0, 4*k, -3*k, 0, -6*k, 0);
      ctx.bezierCurveTo(-10*k, 0, -10*k, 6*k, -10*k, 6*k);
      ctx.bezierCurveTo(-10*k, 10*k, -5*k, 13*k, 0, 16*k);
      ctx.bezierCurveTo(5*k, 13*k, 10*k, 10*k, 10*k, 6*k);
      ctx.bezierCurveTo(10*k, 6*k, 10*k, 0, 6*k, 0);
      ctx.bezierCurveTo(3*k, 0, 0, 4*k, 0, 6*k);
      ctx.closePath(); ctx.fill(); ctx.restore();
    }
    yesBtn.addEventListener("click", ()=>{
      launchConfetti();
      document.getElementById("letter").scrollIntoView({behavior:"smooth", block:"center"});
    });

    // Map & Distance
    const distanceText = document.getElementById("distanceText");
    function haversineKm(a,b){
      const toRad = (deg)=> deg*Math.PI/180;
      const R = 6371; // km
      const dLat = toRad(b.lat - a.lat);
      const dLng = toRad(b.lng - a.lng);
      const lat1 = toRad(a.lat);
      const lat2 = toRad(b.lat);
      const h = Math.sin(dLat/2)**2 + Math.cos(lat1)*Math.cos(lat2)*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(h));
    }

    // Initialize Leaflet map
    let map;
    function initMap(){
      try{
        map = L.map('map', { zoomControl: true, scrollWheelZoom: false });
        const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap'
        });
        tiles.addTo(map);

        const markerA = L.marker([CITY_A.lat, CITY_A.lng]).addTo(map).bindPopup(CITY_A.name || "You");
        const markerB = L.marker([CITY_B.lat, CITY_B.lng]).addTo(map).bindPopup(CITY_B.name || "Her");

        const line = L.polyline([[CITY_A.lat, CITY_A.lng],[CITY_B.lat, CITY_B.lng]], {
          color:'#ff5e78', weight:4, opacity:0.9
        }).addTo(map);

        const group = L.featureGroup([markerA, markerB, line]);
        map.fitBounds(group.getBounds().pad(0.2));

        const km = haversineKm(CITY_A, CITY_B);
        distanceText.textContent = `${(km).toFixed(1)} km apart ‚Ä¢ ${CITY_A.name} ‚Üî ${CITY_B.name}`;
      }catch(e){
        distanceText.textContent = "Map unavailable (offline). We're still beautifully connected. üíû";
      }
    }

    // Back to Top Button
    const backToTopBtn = document.getElementById("backToTop");
    function toggleBackToTop() {
      if (window.scrollY > 300) {
        backToTopBtn.classList.add("visible");
      } else {
        backToTopBtn.classList.remove("visible");
      }
    }
    window.addEventListener("scroll", toggleBackToTop);
    backToTopBtn.addEventListener("click", () => {
      window.scrollTo({
        top: 0,
        behavior: "smooth"
      });
    });

    // Create Our Story Timeline
    function createTimeline() {
      const timelineEl = document.getElementById("timeline");
      OUR_STORY.forEach((item, index) => {
        const itemEl = document.createElement("div");
        itemEl.className = "timeline-item";
        if (item.special) {
          itemEl.style.opacity = "0.9";
          itemEl.style.fontStyle = "italic";
        }
        
        itemEl.innerHTML = `
          <div class="timeline-date">${item.date}</div>
          <h3 class="timeline-title">${item.title}</h3>
          <p class="timeline-desc">${item.desc}</p>
        `;
        
        timelineEl.appendChild(itemEl);
      });
    }

    // Wait a tick for layout, then initialize everything
    setTimeout(() => {
      initMap();
      createTimeline();
      toggleBackToTop(); // Initial check
    }, 50);
  </script>
</body>
</html>